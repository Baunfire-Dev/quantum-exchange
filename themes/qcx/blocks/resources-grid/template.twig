{# Resource Grid V1 — parent/child (category/category) filters with AJAX #}
<section class="{{ block.slug }} {{ block.className }}" style="background:#F7F9FB;">
  {% if block.anchor %}<div class="section-anchor" id="{{ block.anchor ?? block.id }}"></div>{% endif %}

  <div class="mx-auto max-w-[90rem] px-[1rem] md:px-[4rem] py-[4.5rem] md:py-[7.5rem] flex flex-col items-center gap-[3rem] w-full">

    {# FILTER BAR ------------------------------------------------------------ #}
    <div class="flex flex-col md:flex-row flex-wrap  items-start gap-[1.5rem] w-full z-[25]">
      {# TYPE (parent) #}
      <div class="rg-select relative w-full md:w-auto">
        <button class="rg-btn flex w-full md:w-[16.25rem] h-[3.0625rem] px-5 py-3 justify-between items-center rounded-[2.5rem] border border-[#D9D9D9] bg-[#f8f9fb]"
                type="button" data-toggle="type">
          <span class="text-[0.75rem] font-[500] leading-[1.2] tracking-[0.075rem] uppercase">Type</span>
               <svg class="rg-arrow transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
         <path d="M18 9L12 15L6 9" stroke="black" stroke-width="1.5"/>
        </svg>
        </button>
        <div class="rg-menu py-[0.625rem] absolute z-[25] mt-2 w-full md:w-[16.25rem] max-h-[16rem] overflow-auto rounded-[0.5rem] border border-[#D9D9D9] bg-[#f8f9fb] shadow hidden"
             data-menu="type"> {# IMPORTANT: 'type', not 'cat' #}
          <button class="rg-opt block w-full text-left px-4 py-3 hover:bg-gray-100 bg-[#f8f9fb] text-[0.75rem] font-medium leading-[1.2] tracking-[1.2px] uppercase" data-value="">All</button>
          {% for t in type_terms %}
            <button class="rg-opt block w-full text-left px-4 py-3 hover:bg-gray-100 bg-[#f8f9fb] text-[0.75rem] font-medium leading-[1.2] tracking-[1.2px] uppercase" data-value="{{ t.term_id }}">{{ t.name }}</button>
          {% endfor %}
        </div>
      </div>

      {# CATEGORY (child) #}
      <div class="rg-select relative w-full md:w-auto">
        <button class="rg-btn flex w-full md:w-[16.25rem] h-[3.0625rem] px-5 py-3 justify-between items-center rounded-[2.5rem] border border-[#D9D9D9] disabled:opacity-60 bg-[#f8f9fb]"
                type="button" data-toggle="cat" disabled>
          <span class="text-[0.75rem] font-[500] leading-[1.2] tracking-[0.075rem] uppercase">Category</span>
            <svg class="rg-arrow transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 9L12 15L6 9" stroke="black" stroke-width="1.5"/>
            </svg>
        </button>
        <div class="rg-menu py-[0.625rem] absolute z-20 mt-2 w-full md:w-[16.25rem] max-h-[16rem] overflow-auto rounded-[0.5rem] border border-[#D9D9D9]  bg-[#f8f9fb] shadow hidden"
             data-menu="cat">
          <button class="rg-opt block w-full text-left px-4 py-3 hover:bg-gray-100 text-[0.75rem] font-medium leading-[1.2] tracking-[1.2px] uppercase" data-value="">All</button>
          {# Child options are injected after parent selection #}
        </div>
      </div>
    </div>

    {# GRID ------------------------------------------------------------------ #}
    <div class="flex flex-col items-start gap-[2rem] w-full">
      <div id="rg-grid"
           class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-[2rem] gap-x-[1.5rem] w-full"
           data-ppp="{{ rg.ppp }}"
           data-page="1"
           data-type=""
           data-cat=""
           data-post-type="{{ rg.post_type }}"
           data-nonce="{{ rg_nonce }}"
           data-ajax="{{ function('admin_url','admin-ajax.php') }}"
           data-tax-type="{{ rg.tax_type }}"
           data-tax-cat="{{ rg.tax_category }}">

       {# inside #rg-grid #}
        {% if resources and resources|length %}
        {% for r in resources %}
            {% include __DIR__ ~ '/_item.twig' with { r: r, rg_tax: rg.tax_category } %}
        {% endfor %}
        {% else %}
        <p id="rg-empty" class="text-center text-gray-500 w-full">No results found.</p>
        {% endif %}

      </div>

      {# LOAD MORE ----------------------------------------------------------- #}
      <div class="w-full flex justify-center">

        {% include 'components/cta.twig' with {
            'class': 'filled blue rg-more',
            'id': 'rg-more',
            'cta': {
                'url': '#resource-grid',
                'title': 'Load more',
                'target': '_self'
            }
        } %}
      </div>
    </div>
  </div>

  {# Inline JS (self-contained). You can move to an external file later. #}
  <script>
  (function(){
    const root    = document.currentScript.closest('section');
    const grid    = root.querySelector('#rg-grid');
    const more    = root.querySelector('.rg-more'); // <a ...> from CTA
    const selects = root.querySelectorAll('.rg-select');
    let loading   = false;

    const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function toggleMenu(btn){
      const wrap  = btn.closest('.rg-select');
      const menu  = wrap.querySelector('.rg-menu');
      const arrow = btn.querySelector('.rg-arrow');
      const open  = !menu.classList.contains('hidden');

      root.querySelectorAll('.rg-menu').forEach(m => m.classList.add('hidden'));
      root.querySelectorAll('.rg-arrow').forEach(a => a.classList.remove('rotate-180'));

      if(open){
        menu.classList.add('hidden');
        arrow.classList.remove('rotate-180');
      } else {
        menu.classList.remove('hidden');
        arrow.classList.add('rotate-180');
      }
    }

    function wireCatClicks(catMenu){
      catMenu.querySelectorAll('.rg-opt').forEach(opt=>{
        opt.addEventListener('click', (e)=>{
          const btn   = catMenu.closest('.rg-select').querySelector('.rg-btn');
          const label = btn.querySelector('span');
          const val   = e.currentTarget.dataset.value || '';
          label.textContent = e.currentTarget.textContent.trim();
          grid.dataset.cat = val;
          catMenu.classList.add('hidden');
          btn.querySelector('.rg-arrow')?.classList.remove('rotate-180');
          refresh(true);
        });
      });
    }

    function fetchCats(type_id, catMenu){
      catMenu.innerHTML = '<button class="rg-opt block w-full text-left px-4 py-3 hover:bg-gray-100 bg-[#f8f9fb] text-[12px] font-medium leading-[1.2] tracking-[1.2px] uppercase" data-value="">All</button>';

      if(!type_id){
        const row = document.createElement('div');
        row.className = 'px-4 py-3 text-gray-400 text-sm';
        row.textContent = 'No parent selected';
        catMenu.appendChild(row);
        wireCatClicks(catMenu);
        return;
      }

      const fd = new FormData();
      fd.append('action','rg_categories');
      fd.append('nonce', grid.dataset.nonce);
      fd.append('tax_type', grid.dataset.taxType);
      fd.append('type_id',  type_id);

      fetch(grid.dataset.ajax, { method:'POST', body: fd })
        .then(r=>r.json())
        .then(data=>{
          if(Array.isArray(data.cats) && data.cats.length){
            data.cats.forEach(c=>{
              const b = document.createElement('button');
              b.className = 'rg-opt block w-full text-left px-4 py-3 hover:bg-gray-100';
              b.dataset.value = c.term_id;
              b.textContent = c.name;
              catMenu.appendChild(b);
            });
          } else {
            const row = document.createElement('div');
            row.className = 'px-4 py-3 text-gray-400 text-sm';
            row.textContent = 'No categories';
            catMenu.appendChild(row);
          }
          wireCatClicks(catMenu);
        })
        .catch(()=>{
          const row = document.createElement('div');
          row.className = 'px-4 py-3 text-red-500 text-sm';
          row.textContent = 'Failed to load categories';
          catMenu.appendChild(row);
          wireCatClicks(catMenu);
        });
    }

    function syncMoreVisibilityInitial(){
      if(!more) return;
      const ppp   = parseInt(grid.dataset.ppp, 10) || 9;
      const items = grid.querySelectorAll('[data-rg-item]').length;
      more.style.display = (items >= ppp ? 'inline-flex' : 'none');
    }

    // Smooth animate-in for newly added items only
    function animateNewItems(){
      if(!window.gsap || reduceMotion) return;
      const newEls = Array.from(grid.querySelectorAll('[data-rg-item]:not(.is-animated)'));
      if(!newEls.length) return;

      // perf hint
      gsap.set(newEls, { willChange: 'transform, opacity, filter' });

      gsap.fromTo(newEls,
        { autoAlpha: 0, y: 24, filter: 'blur(4px)' },
        {
          autoAlpha: 1,
          y: 0,
          filter: 'blur(0px)',
          duration: 0.55,
          ease: 'power3.out',
          stagger: { each: 0.06, from: 'start' },
          onComplete: () => {
            newEls.forEach(el => el.classList.add('is-animated'));
            // clear perf hint
            gsap.set(newEls, { clearProps: 'will-change' });
          }
        }
      );
    }

    function refresh(resetPage){
      if(loading) return;
      loading = true;
      if(resetPage){ grid.dataset.page = '1'; }

      const fd = new FormData();
      fd.append('action','rg_filter');
      fd.append('nonce', grid.dataset.nonce);
      fd.append('post_type', grid.dataset.postType);
      fd.append('ppp', grid.dataset.ppp);
      fd.append('page', grid.dataset.page);
      fd.append('tax_type', grid.dataset.taxType);
      fd.append('tax_cat',  grid.dataset.taxCat);
      fd.append('type_id',  grid.dataset.type);
      fd.append('cat_id',   grid.dataset.cat);

      grid.style.opacity = '0.4';

      fetch(grid.dataset.ajax, { method:'POST', body: fd })
        .then(r=>r.json())
        .then(data=>{
          grid.style.opacity = '1';
          if(resetPage){ grid.innerHTML = ''; }

          if(data.html){
            // Insert and then animate ONLY the new nodes
            const beforeCount = grid.querySelectorAll('[data-rg-item]').length;
            grid.insertAdjacentHTML('beforeend', data.html);

            // mark previously existing as animated to avoid re-animating
            if(resetPage){
              // fresh render — animate first batch too but still tag them
              // do nothing here; animateNewItems() will catch them
            } else {
              const existing = Array.from(grid.querySelectorAll('[data-rg-item]')).slice(0, beforeCount);
              existing.forEach(el => el.classList.add('is-animated'));
            }

            animateNewItems();

            grid.dataset.page = data.page;
            if(more){
              more.style.display = (data.has_more ? 'inline-flex' : 'none');
            }
          } else {
            grid.innerHTML = '<p id="rg-empty" class="text-center text-gray-500 w-full">No results found.</p>';
            if(more){ more.style.display = 'none'; }
          }
        })
        .catch(()=>{
          grid.style.opacity = '1';
        })
        .finally(()=> loading = false);
    }

    // wire menus
    selects.forEach(s=>{
      const btn = s.querySelector('.rg-btn');
      btn.addEventListener('click', ()=> toggleMenu(btn));

      s.querySelectorAll('.rg-opt').forEach(opt=>{
        opt.addEventListener('click', e=>{
          const val  = e.currentTarget.dataset.value || '';
          const span = btn.querySelector('span');
          span.textContent = e.currentTarget.textContent.trim();
          s.querySelector('.rg-menu').classList.add('hidden');
          btn.querySelector('.rg-arrow').classList.remove('rotate-180');

          if(btn.dataset.toggle === 'type'){
            grid.dataset.type = val;
            grid.dataset.cat  = '';

            const catBtn  = root.querySelector('[data-toggle="cat"]');
            const catMenu = root.querySelector('[data-menu="cat"]');
            catBtn.disabled = false;
            catBtn.querySelector('span').textContent = 'Category';
            catMenu.innerHTML = '<button class="rg-opt block w-full text-left px-4 py-3 hover:bg-gray-100 bg-[#f8f9fb] text-[12px] font-medium leading-[1.2] tracking-[1.2px] uppercase" data-value="">All</button>';
            fetchCats(val, catMenu);

            refresh(true);
          } else {
            grid.dataset.cat = val;
            refresh(true);
          }
        });
      });
    });

    // close dropdowns when clicking outside
    document.addEventListener('click', (e)=>{
      if(!e.target.closest('.rg-select')){
        root.querySelectorAll('.rg-menu').forEach(m=>m.classList.add('hidden'));
        root.querySelectorAll('.rg-arrow').forEach(a=>a.classList.remove('rotate-180'));
      }
    });

    // Load more (anchor — prevent jump)
    if(more){
      more.addEventListener('click', (e)=>{
        e.preventDefault();
        if(loading) return;
        grid.dataset.page = String(parseInt(grid.dataset.page,10) + 1);
        refresh(false);
      });
    }

    // initial states
    syncMoreVisibilityInitial();
    // Animate initial batch once on page load (if GSAP is present)
    // Mark existing items so they don't re-animate on next loads
    if(!reduceMotion && window.gsap){
      animateNewItems();
    } else {
      grid.querySelectorAll('[data-rg-item]').forEach(el => el.classList.add('is-animated'));
    }
  })();
</script>


</section>
