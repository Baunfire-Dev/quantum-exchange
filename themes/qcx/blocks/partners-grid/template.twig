<section class="{{ block.slug }} {{ block.className }} p-grid" style="background:#F7F9FB;">
  {% if block.anchor %}
    <div class="section-anchor" id="{{ block.anchor ?? block.id }}"></div>
  {% endif %}

  <div class="mx-auto max-w-[90rem] px-[1rem] md:px-[4rem] pt-[4.5rem] pb-[4.5rem] md:pt-[7.5rem] md:pb-[5rem] flex flex-col items-center gap-[3rem]">

    {# === CATEGORY FILTER BUTTONS === #}
    <div class="flex flex-wrap items-start gap-[0.75rem] w-full justify-start" id="pg-filters">
      <button class="pg-btn active" data-id="">All Partners</button>
      {% for term in partner_terms %}
        <button class="pg-btn" data-id="{{ term.term_id }}">{{ term.name }}</button>
      {% endfor %}
    </div>

    {# === GRID === #}
   {# === GRID === #}
<div id="pg-grid"
     class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-[2rem] gap-x-[1.5rem] w-full"
     data-ajax="{{ function('admin_url','admin-ajax.php') }}"
     data-nonce="{{ pg_nonce }}"
     data-post-type="{{ pg.post_type }}"
     data-tax="{{ pg.tax }}"
     data-ppp="{{ pg.ppp }}"
     data-page="1"
     data-cat="">


      {% if partners and partners|length %}
        {% for r in partners %}
          {% include __DIR__ ~ '/_item.twig' with { r: r } %}
        {% endfor %}
      {% else %}
        <p class="text-center text-gray-500 w-full">No partners found.</p>
      {% endif %}
    </div>

    {# === LOAD MORE === #}
    <div class="w-full flex justify-center">
      {% include 'components/cta.twig' with {
          'class': 'filled blue pg-more',
          'id': 'pg-more',
          'cta': {
              'url': '#partner-grid',
              'title': 'Load more',
              'target': '_self'
          }
      } %}
    </div>
  </div>

  {# === INLINE SCRIPT === #}
  <script>
  (function(){
    const root = document.currentScript.closest('section');
    const grid = root.querySelector('#pg-grid');
    const more = root.querySelector('.pg-more');
    const buttons = root.querySelectorAll('.pg-btn');
    const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let loading = false;

    // --- Animation ---
    function animateNewItems() {
      if (!window.gsap || reduceMotion) return;
      const newEls = Array.from(grid.querySelectorAll('[data-pg-item]:not(.is-animated)'));
      if (!newEls.length) return;
      gsap.set(newEls, { willChange: 'transform,opacity' });
      gsap.fromTo(newEls,
        { autoAlpha: 0, y: 40 },
        {
          autoAlpha: 1,
          y: 0,
          duration: 0.8,
          ease: 'power3.out',
          stagger: { each: 0.08 },
          onComplete: () => {
            newEls.forEach(el => el.classList.add('is-animated'));
            gsap.set(newEls, { clearProps: 'will-change' });
          }
        });
    }

    // --- Fetch Partners ---
    function refresh(resetPage=true){
      if (loading) return;
      loading = true;
      if (resetPage) grid.dataset.page = '1';

      const fd = new FormData();
      fd.append('action', 'pg_filter');
      fd.append('nonce', grid.dataset.nonce);
      fd.append('post_type', grid.dataset.postType);
      fd.append('ppp', grid.dataset.ppp);
      fd.append('page', grid.dataset.page);
      fd.append('tax', grid.dataset.tax);
      fd.append('cat', grid.dataset.cat);

      fetch(grid.dataset.ajax, { method:'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if (resetPage) grid.innerHTML = '';
          if (data.html) {
            grid.insertAdjacentHTML('beforeend', data.html);
            animateNewItems();
            grid.dataset.page = data.page;
            more.style.display = data.has_more ? 'inline-flex' : 'none';
          } else {
            grid.innerHTML = '<p class="text-center text-gray-500 w-full">No partners found.</p>';
            more.style.display = 'none';
          }
        })
        .finally(() => loading = false);
    }

    // --- Filter Buttons ---
    buttons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        buttons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        grid.dataset.cat = btn.dataset.id || '';
        refresh(true);
      });
    });

    // --- Load More ---
    if (more) {
      more.addEventListener('click', e=>{
        e.preventDefault();
        if (loading) return;
        grid.dataset.page = String(parseInt(grid.dataset.page,10) + 1);
        refresh(false);
      });
    }

    // Initial Animation
    animateNewItems();
  })();
  </script>


</section>
